{"filter":false,"title":"InvoiceController.php","tooltip":"/app/Http/Controllers/InvoiceController.php","undoManager":{"mark":41,"position":41,"stack":[[{"start":{"row":1223,"column":41},"end":{"row":1224,"column":0},"action":"insert","lines":["",""],"id":2},{"start":{"row":1224,"column":0},"end":{"row":1224,"column":8},"action":"insert","lines":["        "]},{"start":{"row":1224,"column":8},"end":{"row":1225,"column":0},"action":"insert","lines":["",""]},{"start":{"row":1225,"column":0},"end":{"row":1225,"column":8},"action":"insert","lines":["        "]},{"start":{"row":1225,"column":8},"end":{"row":1226,"column":0},"action":"insert","lines":["",""]},{"start":{"row":1226,"column":0},"end":{"row":1226,"column":8},"action":"insert","lines":["        "]}],[{"start":{"row":1225,"column":8},"end":{"row":1236,"column":11},"action":"insert","lines":["$invoiceItems = InvoiceItem::query()","        ->with(['invoice', 'invoice.client', 'productCategory', 'ivaType'])","        ->where('year', $this->year)","        ->where('month', $this->month)","        ->whereHas('invoice', function ($query) use ($current_company){","            $query","            ->where('company_id', $current_company)","            ->where('is_void', false)","            ->where('is_authorized', true)","            ->where('is_code_validated', true)","            ->where('hide_from_taxes', false);","        });"],"id":3}],[{"start":{"row":1225,"column":8},"end":{"row":1225,"column":21},"action":"remove","lines":["$invoiceItems"],"id":4},{"start":{"row":1225,"column":8},"end":{"row":1225,"column":9},"action":"insert","lines":["$"]},{"start":{"row":1225,"column":9},"end":{"row":1225,"column":10},"action":"insert","lines":["q"]},{"start":{"row":1225,"column":10},"end":{"row":1225,"column":11},"action":"insert","lines":["u"]},{"start":{"row":1225,"column":11},"end":{"row":1225,"column":12},"action":"insert","lines":["e"]},{"start":{"row":1225,"column":12},"end":{"row":1225,"column":13},"action":"insert","lines":["r"]},{"start":{"row":1225,"column":13},"end":{"row":1225,"column":14},"action":"insert","lines":["y"]}],[{"start":{"row":1225,"column":8},"end":{"row":1225,"column":14},"action":"remove","lines":["$query"],"id":5},{"start":{"row":1225,"column":8},"end":{"row":1225,"column":9},"action":"insert","lines":["$"]}],[{"start":{"row":1225,"column":9},"end":{"row":1225,"column":10},"action":"insert","lines":["i"],"id":6},{"start":{"row":1225,"column":10},"end":{"row":1225,"column":11},"action":"insert","lines":["t"]},{"start":{"row":1225,"column":11},"end":{"row":1225,"column":12},"action":"insert","lines":["e"]},{"start":{"row":1225,"column":12},"end":{"row":1225,"column":13},"action":"insert","lines":["m"]},{"start":{"row":1225,"column":13},"end":{"row":1225,"column":14},"action":"insert","lines":["s"]},{"start":{"row":1225,"column":14},"end":{"row":1225,"column":15},"action":"insert","lines":["Q"]},{"start":{"row":1225,"column":15},"end":{"row":1225,"column":16},"action":"insert","lines":["u"]},{"start":{"row":1225,"column":16},"end":{"row":1225,"column":17},"action":"insert","lines":["e"]},{"start":{"row":1225,"column":17},"end":{"row":1225,"column":18},"action":"insert","lines":["r"]},{"start":{"row":1225,"column":18},"end":{"row":1225,"column":19},"action":"insert","lines":["y"]}],[{"start":{"row":1236,"column":11},"end":{"row":1237,"column":0},"action":"insert","lines":["",""],"id":7},{"start":{"row":1237,"column":0},"end":{"row":1237,"column":8},"action":"insert","lines":["        "]},{"start":{"row":1237,"column":8},"end":{"row":1238,"column":0},"action":"insert","lines":["",""]},{"start":{"row":1238,"column":0},"end":{"row":1238,"column":8},"action":"insert","lines":["        "]}],[{"start":{"row":1238,"column":8},"end":{"row":1253,"column":9},"action":"insert","lines":["$count = $query->count();","        ","        if($count < 25000){","            $billItems = $query->get();","            foreach($billItems as $item){","                  $item->calcularAcreditablePorLinea();","            }","            if( $companyId == 1110 ){","                return Excel::download(new LibroComprasExportSM($year, $month), 'libro-compras.xlsx');","            }","            return Excel::download(new LibroComprasExport($year, $month), 'libro-compras.xlsx');","        }else{","            $user = auth()->user();","            GenerateBookReport::dispatchNow('BILL', $query->get(), $user, $company, $year, $month);","            return back()->withMessage('Su libro de compras es demasiado grande, en unos minutos será enviado a su correo electrónico: ' . $user->email );","        }"],"id":8}],[{"start":{"row":1252,"column":52},"end":{"row":1252,"column":59},"action":"remove","lines":["compras"],"id":9},{"start":{"row":1252,"column":52},"end":{"row":1252,"column":53},"action":"insert","lines":["v"]},{"start":{"row":1252,"column":53},"end":{"row":1252,"column":54},"action":"insert","lines":["e"]},{"start":{"row":1252,"column":54},"end":{"row":1252,"column":55},"action":"insert","lines":["n"]},{"start":{"row":1252,"column":55},"end":{"row":1252,"column":56},"action":"insert","lines":["t"]},{"start":{"row":1252,"column":56},"end":{"row":1252,"column":57},"action":"insert","lines":["a"]},{"start":{"row":1252,"column":57},"end":{"row":1252,"column":58},"action":"insert","lines":["s"]}],[{"start":{"row":1246,"column":43},"end":{"row":1246,"column":63},"action":"remove","lines":["LibroComprasExportSM"],"id":10},{"start":{"row":1246,"column":43},"end":{"row":1246,"column":62},"action":"insert","lines":["LibroVentasExportSM"]}],[{"start":{"row":1248,"column":39},"end":{"row":1248,"column":57},"action":"remove","lines":["LibroComprasExport"],"id":11},{"start":{"row":1248,"column":39},"end":{"row":1248,"column":56},"action":"insert","lines":["LibroVentasExport"]}],[{"start":{"row":1246,"column":86},"end":{"row":1246,"column":93},"action":"remove","lines":["compras"],"id":12},{"start":{"row":1246,"column":86},"end":{"row":1246,"column":92},"action":"insert","lines":["ventas"]}],[{"start":{"row":1248,"column":80},"end":{"row":1248,"column":87},"action":"remove","lines":["compras"],"id":13},{"start":{"row":1248,"column":80},"end":{"row":1248,"column":86},"action":"insert","lines":["ventas"]}],[{"start":{"row":1251,"column":45},"end":{"row":1251,"column":49},"action":"remove","lines":["BILL"],"id":14},{"start":{"row":1251,"column":45},"end":{"row":1251,"column":46},"action":"insert","lines":["I"]},{"start":{"row":1251,"column":46},"end":{"row":1251,"column":47},"action":"insert","lines":["N"]},{"start":{"row":1251,"column":47},"end":{"row":1251,"column":48},"action":"insert","lines":["O"]}],[{"start":{"row":1251,"column":47},"end":{"row":1251,"column":48},"action":"remove","lines":["O"],"id":15}],[{"start":{"row":1251,"column":47},"end":{"row":1251,"column":48},"action":"insert","lines":["V"],"id":16},{"start":{"row":1251,"column":48},"end":{"row":1251,"column":49},"action":"insert","lines":["O"]},{"start":{"row":1251,"column":49},"end":{"row":1251,"column":50},"action":"insert","lines":["I"]},{"start":{"row":1251,"column":50},"end":{"row":1251,"column":51},"action":"insert","lines":["C"]},{"start":{"row":1251,"column":51},"end":{"row":1251,"column":52},"action":"insert","lines":["E"]}],[{"start":{"row":1251,"column":55},"end":{"row":1251,"column":61},"action":"remove","lines":["$query"],"id":17},{"start":{"row":1251,"column":55},"end":{"row":1251,"column":66},"action":"insert","lines":["$itemsQuery"]}],[{"start":{"row":1238,"column":17},"end":{"row":1238,"column":23},"action":"remove","lines":["$query"],"id":18},{"start":{"row":1238,"column":17},"end":{"row":1238,"column":28},"action":"insert","lines":["$itemsQuery"]}],[{"start":{"row":1240,"column":27},"end":{"row":1244,"column":13},"action":"remove","lines":["","            $billItems = $query->get();","            foreach($billItems as $item){","                  $item->calcularAcreditablePorLinea();","            }"],"id":19}],[{"start":{"row":1249,"column":9},"end":{"row":1254,"column":90},"action":"remove","lines":["","        ","        if( $company->id == 1110 ){","            return Excel::download(new LibroVentasExportSM($year, $month), 'libro-ventas.xlsx');","        }","        return Excel::download(new LibroVentasExport($year, $month), 'libro-ventas.xlsx');"],"id":20}],[{"start":{"row":42,"column":37},"end":{"row":43,"column":32},"action":"insert","lines":["","use App\\Jobs\\GenerateBookReport;"],"id":21}],[{"start":{"row":1241,"column":18},"end":{"row":1241,"column":19},"action":"remove","lines":["<"],"id":22}],[{"start":{"row":1241,"column":18},"end":{"row":1241,"column":19},"action":"insert","lines":[">"],"id":23}],[{"start":{"row":1241,"column":18},"end":{"row":1241,"column":19},"action":"remove","lines":[">"],"id":24}],[{"start":{"row":1241,"column":18},"end":{"row":1241,"column":19},"action":"insert","lines":["<"],"id":25}],[{"start":{"row":1228,"column":24},"end":{"row":1228,"column":35},"action":"remove","lines":["$this->year"],"id":26},{"start":{"row":1228,"column":24},"end":{"row":1228,"column":29},"action":"insert","lines":["$year"]}],[{"start":{"row":1229,"column":25},"end":{"row":1229,"column":37},"action":"remove","lines":["$this->month"],"id":27},{"start":{"row":1229,"column":25},"end":{"row":1229,"column":31},"action":"insert","lines":["$month"]}],[{"start":{"row":1230,"column":53},"end":{"row":1230,"column":69},"action":"remove","lines":["$current_company"],"id":28},{"start":{"row":1230,"column":53},"end":{"row":1230,"column":61},"action":"insert","lines":["$company"]}],[{"start":{"row":1230,"column":61},"end":{"row":1230,"column":62},"action":"insert","lines":["/"],"id":29}],[{"start":{"row":1230,"column":61},"end":{"row":1230,"column":62},"action":"remove","lines":["/"],"id":30}],[{"start":{"row":1230,"column":61},"end":{"row":1230,"column":62},"action":"insert","lines":["-"],"id":31},{"start":{"row":1230,"column":62},"end":{"row":1230,"column":63},"action":"insert","lines":[">"]},{"start":{"row":1230,"column":63},"end":{"row":1230,"column":64},"action":"insert","lines":["i"]},{"start":{"row":1230,"column":64},"end":{"row":1230,"column":65},"action":"insert","lines":["d"]}],[{"start":{"row":1232,"column":34},"end":{"row":1232,"column":50},"action":"remove","lines":["$current_company"],"id":32},{"start":{"row":1232,"column":34},"end":{"row":1232,"column":42},"action":"insert","lines":["$company"]}],[{"start":{"row":1232,"column":42},"end":{"row":1232,"column":43},"action":"insert","lines":["-"],"id":33},{"start":{"row":1232,"column":43},"end":{"row":1232,"column":44},"action":"insert","lines":[">"]},{"start":{"row":1232,"column":44},"end":{"row":1232,"column":45},"action":"insert","lines":["i"]},{"start":{"row":1232,"column":45},"end":{"row":1232,"column":46},"action":"insert","lines":["d"]}],[{"start":{"row":1230,"column":63},"end":{"row":1230,"column":65},"action":"remove","lines":["id"],"id":34},{"start":{"row":1230,"column":62},"end":{"row":1230,"column":63},"action":"remove","lines":[">"]},{"start":{"row":1230,"column":61},"end":{"row":1230,"column":62},"action":"remove","lines":["-"]}],[{"start":{"row":1224,"column":41},"end":{"row":1225,"column":34},"action":"insert","lines":["","        $companyId = $company->id;"],"id":35}],[{"start":{"row":1231,"column":53},"end":{"row":1231,"column":61},"action":"remove","lines":["$company"],"id":36},{"start":{"row":1231,"column":53},"end":{"row":1231,"column":63},"action":"insert","lines":["$companyId"]}],[{"start":{"row":1233,"column":34},"end":{"row":1233,"column":46},"action":"remove","lines":["$company->id"],"id":37},{"start":{"row":1233,"column":34},"end":{"row":1233,"column":44},"action":"insert","lines":["$companyId"]}],[{"start":{"row":1242,"column":18},"end":{"row":1242,"column":19},"action":"remove","lines":["<"],"id":38}],[{"start":{"row":1242,"column":18},"end":{"row":1242,"column":19},"action":"insert","lines":[">"],"id":39}],[{"start":{"row":1242,"column":18},"end":{"row":1242,"column":19},"action":"remove","lines":[">"],"id":40}],[{"start":{"row":1242,"column":18},"end":{"row":1242,"column":19},"action":"insert","lines":["<"],"id":41}],[{"start":{"row":1249,"column":42},"end":{"row":1249,"column":43},"action":"remove","lines":["w"],"id":42},{"start":{"row":1249,"column":41},"end":{"row":1249,"column":42},"action":"remove","lines":["o"]},{"start":{"row":1249,"column":40},"end":{"row":1249,"column":41},"action":"remove","lines":["N"]}],[{"start":{"row":1250,"column":62},"end":{"row":1250,"column":71},"action":"remove","lines":["demasiado"],"id":43},{"start":{"row":1250,"column":62},"end":{"row":1250,"column":63},"action":"insert","lines":["m"]},{"start":{"row":1250,"column":63},"end":{"row":1250,"column":64},"action":"insert","lines":["u"]},{"start":{"row":1250,"column":64},"end":{"row":1250,"column":65},"action":"insert","lines":["y"]}]]},"ace":{"folds":[],"scrolltop":16907,"scrollleft":0,"selection":{"start":{"row":1237,"column":46},"end":{"row":1237,"column":46},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":122,"state":"php-start","mode":"ace/mode/php"}},"timestamp":1584060444495,"hash":"6185b8f5cf92930c032eabf66bd283aebd6146b5"}