{"filter":false,"title":"InvoiceController.php","tooltip":"/app/Http/Controllers/InvoiceController.php","undoManager":{"mark":0,"position":0,"stack":[[{"start":{"row":114,"column":8},"end":{"row":115,"column":8},"action":"insert","lines":["$years = Invoice::select('invoices.year')->where('invoices.company_id', '=', $company->id)->groupBy('invoices.year')->get();","        "],"id":2},{"start":{"row":115,"column":93},"end":{"row":115,"column":102},"action":"insert","lines":["s', 'year"]},{"start":{"row":186,"column":68},"end":{"row":191,"column":67},"action":"insert","lines":[");","       }","","       $filtroAno = $request->get('filtroAno');","       if($filtroAno > 0){","            $query = $query->where('invoice_items.year', $filtroAno"]},{"start":{"row":555,"column":16},"end":{"row":555,"column":18},"action":"insert","lines":["//"]},{"start":{"row":555,"column":56},"end":{"row":556,"column":32},"action":"insert","lines":[";","                $tokenApi = true"]},{"start":{"row":640,"column":0},"end":{"row":641,"column":0},"action":"remove","lines":["",""]},{"start":{"row":688,"column":28},"end":{"row":688,"column":30},"action":"insert","lines":["//"]},{"start":{"row":689,"column":0},"end":{"row":706,"column":2},"action":"remove","lines":["                        }","//","//                        if ($request->document_type == '01') {","//                            $company->last_invoice_ref_number = $invoice->reference_number;","//                            $company->last_document = $invoice->document_number;","//","//                        } elseif ($request->document_type == '08') {","//                            $company->last_invoice_pur_ref_number = $invoice->reference_number;","//                            $company->last_document_invoice_pur = $invoice->document_number;","//","//                        } elseif ($request->document_type == '09') {","//                            $company->last_invoice_exp_ref_number = $invoice->reference_number;","//                            $company->last_document_invoice_exp = $invoice->document_number;","","//                        } elseif ($request->document_type == '04') {","//                            $company->last_ticket_ref_number = $invoice->reference_number;","//                            $company->last_document_ticket = $invoice->document_number;","//"]},{"start":{"row":693,"column":20},"end":{"row":693,"column":22},"action":"insert","lines":["//"]},{"start":{"row":716,"column":9},"end":{"row":716,"column":10},"action":"insert","lines":[" "]},{"start":{"row":2050,"column":0},"end":{"row":2051,"column":0},"action":"remove","lines":["",""]},{"start":{"row":2050,"column":8},"end":{"row":2050,"column":21},"action":"remove","lines":["   /* $start_"]},{"start":{"row":2050,"column":9},"end":{"row":2051,"column":15},"action":"remove","lines":["ate = Carbon::parse(now('America/Costa_Rica'));","            $to"]},{"start":{"row":2050,"column":10},"end":{"row":2051,"column":38},"action":"remove","lines":["ay = $start_date->year.\"-\".$start_date->month.\"-\".$start_date->day.\" 23:59:59\";","            $invoices = Invoice::where"]},{"start":{"row":2050,"column":12},"end":{"row":2050,"column":13},"action":"remove","lines":["h"]},{"start":{"row":2050,"column":13},"end":{"row":2050,"column":18},"action":"remove","lines":["ciend"]},{"start":{"row":2050,"column":14},"end":{"row":2050,"column":17},"action":"remove","lines":["_st"]},{"start":{"row":2050,"column":15},"end":{"row":2050,"column":39},"action":"remove","lines":["tus\",'99')->where('gener"]},{"start":{"row":2050,"column":16},"end":{"row":2098,"column":30},"action":"remove","lines":["ted_date', '<=',$today)->get();","            foreach ($invoices as $invoice) {","                try{","                    $company = Company::where('id',$invoice->company_id)->first();","                    if ($invoice->document_type == '01') {","                        $invoice->reference_number = $company->last_invoice_ref_number + 1;","                    }","                    if ($invoice->document_type == '08') {","                        $invoice->reference_number = $company->last_invoice_pur_ref_number + 1;","                    }","                    if ($invoice->document_type == '09') {","                        $invoice->reference_number = $company->last_invoice_exp_ref_number + 1;","                    }","                    if ($invoice->document_type == '04') {","                        $invoice->reference_number = $company->last_ticket_ref_number + 1;","                    }","                    if ($invoice->document_type== '02') {","                        $invoice->reference_number = $company->last_debit_note_ref_number + 1;","                    }","                    if ($invoice->document_type == '03') {","                        $invoice->reference_number= $company->last_note_ref_number + 1;","                    }","                    $invoice->document_key = $this->getDocumentKey($invoice->document_type,$company);","                    $invoice->document_number = $this->getDocReference($invoice->document_type,$company);","                    $invoice->hacienda_status = '01';","                    $invoice->company->addSentInvoice( $invoice->year, $invoice->month );","","                    if ($invoice->document_type == '01') {","                         $company->last_invoice_ref_number = $invoice->reference_number;","                    }","                    if ($invoice->document_type == '08') {","                        $company->last_invoice_pur_ref_number = $invoice->reference_number;","                    }","                    if ($invoice->document_type== '02') {","                        $company->last_debit_note_ref_number = $invoice->reference_number;","                    }","                    if ($invoice->document_type == '03') {","                       $company->last_note_ref_number = $invoice->reference_number;","                    }","                    if ($invoice->document_type == '09') {","                        $company->last_invoice_exp_ref_number = $invoice->reference_number;","                    }","                    if ($invoice->document_type == '04') {","                        $company->last_ticket_ref_number = $invoice->reference_number;","                    }","","                    $company->save();","                    $invoice->save();","                    Log::info("]},{"start":{"row":2050,"column":17},"end":{"row":2050,"column":114},"action":"remove","lines":["Factura  programada enviada de la compañia\".$company->id.\" con la llave\" . $invoice->document_key"]},{"start":{"row":2050,"column":19},"end":{"row":2056,"column":15},"action":"remove","lines":["","                    dd(\"Factura  programada enviada de la compañia\".$company->id.\" con la llave\" . $invoice->document_key);","                }catch( \\Throwable $ex ){","                    Log::error(\"error en envio de programada \".$invoice->id.\" error :\" . $ex);","                    dd(\"error en envio de programada \".$invoice->id.\" error :\" . $ex);","                }","            }*/"]},{"start":{"row":2332,"column":10},"end":{"row":2332,"column":12},"action":"insert","lines":["  "]},{"start":{"row":2343,"column":28},"end":{"row":2343,"column":38},"action":"remove","lines":["'/facturas"]},{"start":{"row":2343,"column":28},"end":{"row":2343,"column":29},"action":"insert","lines":[")"]},{"start":{"row":2343,"column":30},"end":{"row":2343,"column":36},"action":"remove","lines":["emitid"]},{"start":{"row":2343,"column":30},"end":{"row":2343,"column":32},"action":"insert","lines":[">b"]},{"start":{"row":2343,"column":33},"end":{"row":2343,"column":37},"action":"remove","lines":["s/re"]},{"start":{"row":2343,"column":34},"end":{"row":2343,"column":43},"action":"remove","lines":["urrentes'"]},{"start":{"row":2343,"column":34},"end":{"row":2343,"column":36},"action":"insert","lines":["k("]},{"start":{"row":2343,"column":69},"end":{"row":2343,"column":70},"action":"insert","lines":["."]},{"start":{"row":2346,"column":28},"end":{"row":2346,"column":38},"action":"remove","lines":["'/facturas"]},{"start":{"row":2346,"column":28},"end":{"row":2346,"column":29},"action":"insert","lines":[")"]},{"start":{"row":2346,"column":30},"end":{"row":2346,"column":36},"action":"remove","lines":["emitid"]},{"start":{"row":2346,"column":30},"end":{"row":2346,"column":32},"action":"insert","lines":[">b"]},{"start":{"row":2346,"column":33},"end":{"row":2346,"column":37},"action":"remove","lines":["s/re"]},{"start":{"row":2346,"column":34},"end":{"row":2346,"column":43},"action":"remove","lines":["urrentes'"]},{"start":{"row":2346,"column":34},"end":{"row":2346,"column":36},"action":"insert","lines":["k("]}]]},"ace":{"folds":[],"scrolltop":28291,"scrollleft":0,"selection":{"start":{"row":2047,"column":0},"end":{"row":2049,"column":58},"isBackwards":true},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":7,"state":"php-start","mode":"ace/mode/php"}},"timestamp":1574808030194,"hash":"3f1e07e24426b7d092f6479b3f1e9a4d20367cd4"}